---
title: Grade Retention and Mixed Race
author: Aaron Gullickson
abstract: This is a test abstract
thanks: Thanks to people and stuff
format:
  pdf:
    documentclass: scrartcl
    papersize: letter
    fig-height: 4
    fig-pos: htb
    #template: resources/aog-latex-ms.tex
bibliography: ../project.bib
execute: 
  eval: true
  echo: false
  warning: false
  error: false
editor: source
---

```{r setup}
#| include: false
library(here)
source(here("analysis","check_packages.R"))
source(here("analysis","useful_functions.R"))
```

```{r load-data}
load(here("analysis","output","acs.RData"))
load(here("analysis","output","coef_table.RData"))
load(here("analysis","output","monoracial_results.RData"))
# change names of models for display
coef_table <- coef_table %>%
  mutate(model=factor(model,
                      levels=c("crude","fixed effects","cultural resources",
                               "parent resources"),
                      labels=c("Raw","Baseline model","Cultural model",
                               "Full model")))
```

# Introduction

# Background

# Data and Methods

Data for this analysis come from the American Community Survey (ACS), an annual 1-in-100 survey of the US population, produced by the Census Bureau. To increase sample size for smaller populations of biracial respondents, I pool ACS data for a full decade from 2010-2019. While pooling data helps to increase sample size, it may generate biases if the likelihood of grade retention is changing over time in complex way. I address this issue in the modeling techniques discussed below. All data were extracted from the Minnesota Population Center's Integrated Public Use Microdata Series (CITATION).

Ideally, I would restrict the sample only to children living in a household with two biological parents. However, the ACS data only records the family relationship between the head of household and all other members of the family. Since 2008, the ACS also distinguishes between biological children, adopted children, and stepchildren. Respondents can therefore be identified as biological children of one member of the household if that member is the head of household or the biological child of the head of household. However, identifying whether the partner/spouse of that biological parent is also the biological parent rather than a stepparent is more difficult and cannot be determined perfectly.

Prior work has used a variety of additional restrictions to limit the analysis to children who are more likely to be the biological children of both parents (CITE Saenz and Xie & Goyette). Some of those procedures rely upon an assumption that most parents would be married that was more tenable in historical but less tenable in contemporary data. Therefore, I do not explicitly restrict by marital status, I do restrict cases in two other ways. First, I restrict the sample to cases where both parents were of a reasonable age at the birth of the child (aged 15-44 for mothers and aged 15-60 for fathers). Second, I restrict the sample to only those cases where the reported race and Hispanicity of the child is consistent with at least one of the parents.

The final analytical sample consists of children aged 5-20 who are currently enrolled in the K-12 school system and live in a household with two parents who are both likely to be biological parents. This necessary sample restriction will bias the family structure of the analytical sample relative to the total population of K-12 schoolchildren, limiting it exclusively to households with two parents present and overrepresenting the proportion of cases in which those parents are married. The result of this bias is well-known. Children living in two-parent nuclear households have greater educational success than other children as a result of material, social, and cultural resources (CITATIONS). Therefore, the overall estimate of grade retention will be biased upward. However, the goal of this study is to estimate differences between groups which will not necessarily be affected by this bias, unless the differences across racial groups in other family forms are different.

The race of children is calculated by a cross-tabulation of parent's races. A full cross-tabulation of the 17 (CHECK) categories of race in the ACS combined with the 4 (CHECK) categories of Hispanicity would produce far too many combined categories to be analytically useful. Therefore, I collapse each parent's race into the categories of White, Black, Asian, Latino, and Indigenous. These categories form the "ethnoracial pentagon" that is commonly used in popular practice and government tabulation to identify race in the US (CITE Hollinger). Respondents are identified as Latino if they responded with a Latino identitification to the Hispanicity question, regardless of their response to the race question. Respondents are identified as Indigenous if they responded as either American Indian/Alaska Native or as Pacific Islander. Because the goal of my analysis is to examine specifically the outcomes of "first-generation" biracial children, I exclude cases where at least one of the parents identified with multiple races.

the cross-tabulation of parent's races leads to ten distinct biracial categories that respondents may fall into. The total sample size for each of these biracial categories is shown in @tbl-descriptive, along with several descriptive statistics. The sample sizes are quite large for many of the groups, suggesting substantial statistical power in determining the relative outcomes for these groups. Even among the smallest group of Indigenous/Asian, the sample size is substantially greater than one would see in typical survey data.

```{r}
#| label: tbl-descriptive
#| tbl-cap: Descriptive statistics by race. Shading indicates biracial group. Groups ordered by sample size.
tbl_summary <- acs %>%
  group_by(race) %>%
  summarize(n=n(), 
            held_back=percent(mean(below_exp_grade), accuracy=0.01),
            mean_age=round(mean(age), 1),
            f_born=percent(mean(foreign_born),  accuracy=0.1),
            par_fb=percent(mean(foreign_born_father | 
                                  foreign_born_mother), accuracy=0.1),
            fam_inc=dollar(round(mean(family_income), 0)),
            own_home=percent(mean(own_home), accuracy=0.1),
            par_ba=percent(mean(degree_father=="BA" | 
                                  degree_father=="G" | 
                                  degree_mother=="BA" | 
                                  degree_mother=="G"), accuracy=0.1)
  ) %>%
  arrange(desc(n)) %>%
  mutate(n=comma(n))

index_biracial <- which(str_detect(tbl_summary$race, "/"))

tbl_summary %>%
  kbl(booktabs = TRUE,
      linesep = NULL,
      align = c("l",rep("r", ncol(tbl_summary)-1)),
      col.names=c("race",
                  "n",
                  "clearly below expected grade", 
                  "mean age",
                  "foreign-born",
                  "either parent foreign-born",
                  "mean family income",
                  "own home",
                  "either parent, college degree"
      )) %>%
  column_spec(3:10, width = "1.6cm") %>%
  row_spec(index_biracial, background = "#D3D3D3") %>%
  landscape()
```

```{r}
#| eval: false
#| label: fig-sample-size
#| fig-cap: Sample size of biracial respondents combined across American Community Survey data.
acs %>%
  filter(str_detect(race, "/")) %>%
  ggplot(aes(x=reorder(race, race, length)))+
  geom_bar()+
  coord_flip()+
  labs(x=NULL, y="number of respondents")+
  scale_y_continuous(labels = scales::comma)+
  theme_bw()
```

To measure grade retention, I compare the age of respondents to their current grade in school. Because the ACS lacks data on the exact birthday of respondents, it is not possible to exactly identify students who are below the expected grade level. All grades include two expected age groups and a student of a given age could always reasonable be expected to be in two different grades. For example, a first grader is expected to be either six or seven years of age, while a second grader is expected to be either seven or eight years of age. Therefore, with information only on current grade and age in years, it is impossible to determine whether a seven year old in first grade has been held back or is at the expected grade level.

Instead of trying to identify exact grade retention, I instead identify cases in which students are clearly behind grade expectations. This is identified when the age of the respondent is greater than either of the possible ages for a student of that grade (e.g. a first grader who is eight years old). This measure will underestimate the total proportion of students that have been held back. However, the goal of the analysis is to examine differences across groups rather than total levels. The only factor determining this bias is whether the birthday of the student takes place earlier or later in the year, and is unlikely to vary substantially across groups.[^1]

[^1]: Biracial respondents are slightly younger than monoracial respondents in the sample as a whole because interracial unions are becoming more common over time HOW STRONG COULD THE BIAS BE HERE AND WHAT CAN I DO ABOUT IT?

The analysis is driven by a set of logit models that predict the likelihood of a student being clearly behind grade. For the baseline model, I consider several characteristics that may vary across groups and thus need to be controlled in all models. First, states dictates educational policy and thus can differ substantially in the likelihood of grade retention so I include fixed effects for state of residence in all analysis. I cannot identify specific school districts, but I also include dummy variables indicating whether the student lived in a central city, suburban, or rural area.[^2]

[^2]: The location cannot be determined for all students and I therefore also include a fourth category of unknown in all models.

The probability of being clearly behind grade also increases with grade and so I include fixed effects for the current grade of the respondent. Finally, there may be changes over time in the probability of being clearly behind grade. In general, educational reforms have recently decreased the frequency of grade retention (CITE). As @fig-year-grade shows, the percent of students clearly behind grade level has declined over time, but this decline has been more substantial at higher grade levels. For the elementary grades, there is no evidence of a decline at all.

```{r}
#| label: fig-year-grade
#| fig-cap: Trends over time and grade in the percent of students clearly behind grade level. Lines are fit to each set of points by grade via lowess smoothing.
  
acs %>%
  group_by(current_grade, year) %>%
  summarize(below_grade=mean(below_exp_grade)) %>%
  ggplot(aes(x=year, y=below_grade, group=current_grade, color=current_grade))+
  #geom_line()+
  geom_smooth(se=FALSE)+
  geom_point()+
  scale_x_continuous(breaks=c(2010,2014,2018))+
  scale_y_continuous(labels=scales::percent)+
  labs(x="year", y="percent clearly behind grade level for age",
       color="current grade")+
  theme_bw()
```

To account for this grade-specific decline in the models I include an interaction between a linear year term and current grade. Sensitivity analysis showed that this functional form was preferred by BIC to models with no interaction and a model with interaction terms that treated year as a categorical variable. (==SHOULD I BE CONSIDERING THE SAME FOR STATE?==)

The baseline model also includes the race of the respondent. I then add additional terms measuring material and cultural resources that may account for racial differences in a set of subsequent models. First, I include measures of nativity and English proficiency for both the respondent and each of their parents. Second, I include a categorical measure of highest degree earned for each parent. Finally, I include other measures of family income (square rooted), home ownership, and whether the parents are married. All models account for the clustering of multiple respondents within the same household.

Output from the full models is available in the supplementary materials provided with this article. However, this output is not particularly useful for directly evaluating the relative placement of biracial students compared to their monoracial peers (e.g. a White/Black student compared to White and Black students). Throughout this article, I instead use a visual approach to illustrate this placement.

To illustrate via an example, I take the raw percent of students clearly behind grade for White, Black, and Black/White students. These percents are 3.42%, 5.30%, and 3.64%. I then display these probabilities in @fig-example. This figure clearly shows the placement of Black/White students (shown in red) relative to White and Black students. I show uncertainty for all three cases with 83.4% confidence intervals. I use 83.4% confidence intervals because overlap on such intervals indicates that the difference between the two measures is statistically distinguishable from zero at $p<.05$ (CITE). This is not true of overlap with 95% confidence intervals. The lack of overlap of the Black/White probability with either the White or Black bands indicates that it is statistically distinguishable from both monoracial probabilities.

```{r example-plot}
#| label: fig-example
#| fig-cap: Probability of being behind grade for biracial black/white respondents in comparison to their monoracial comparison groups. 83.4% confidence bands shown around each estimate. Non-overlap in confidence bands roughly indicates statistically significant difference at the 5% level.
g <-  coef_table %>%
  filter(mrace=="Black/White" & model=="Raw") %>%
  ggplot(aes(x=term, y=estimate, color=multiracial,
             ymin=estimate-1.386*se, ymax=estimate+1.386*se))+
  geom_rect(aes(xmax=Inf, xmin=-Inf, ymin=estimate_mid-1.386*se_mid,
                ymax=estimate_mid+1.386*se_mid, fill=multiracial), 
            color=NA, alpha=0.2)+
  geom_linerange(data=subset(coef_table, multiracial & mrace=="Black/White" &
                               model=="Raw"))+
  geom_point()+
  coord_flip()+
  theme_bw()+
  theme(legend.position = "none", panel.grid = element_blank())+
  scale_color_manual(values=c("grey40","red"))+
  scale_fill_manual(values=c("grey40","red"))+
  scale_linetype_manual(values=c(3,1))+
  scale_y_continuous(labels = scales::percent)+
  labs(x=NULL,
       y="predicted probability of being behind expected grade")

g+annotate("text", 1, 0.035, hjust="left",
             label="Grey bands give 83.4%\nconfidence interval around\nmonoracial estimates")+
  annotate("text", 2, 0.045, hjust="left",
             label="Red band gives 83.4%\nconfidence interval around\nmidpoint estimate")+
  annotate("text", 2.5, 0.036, hjust="left",
             label="Actual biracial estimate\nshown with 83.4% confidence\ninterval")
```

Additionally, I include a measure of the "halfway" point between the two racial groups.^[The standard error of this halfway estimate used to construct the confidence interval is given by $\sqrt{(s_1^2+s_2^2)/2}$.] This allows me to additionally determine where the biracial group falls relative to the expecation of being halfway between the two constituent monoracial groups. In this case, we can see that Black/White students are much closer to White students in their risk of grade retention, and have grade retention rates much lower than bpth Black students and the halfway expectation.

@fig-example shows the raw differences between groups. To create this same figure from model results that account for potential confounders, I calculate average predicted probabilities (APP). Given a logit model, APPs account for control variables within a model to estimate the average predicted probability of the outcome for a given category. APPs are akin to average marginal effects (AME) and estimated in the same way (the delta method). Whereas AMEs estimate differences or slopes, APPs estimate the level for a given category.

# Results

-   Show table of results for monoracial respondents across different models

```{r monoracial-results}
#| results: asis
#| label: tbl-monoracial
#| tbl-cap: Average marginal differences in the probability of being behind grade by monoracial group, relative to a monoracial white student
texreg(map(results_monoracial, convert_marg),
       digits=3,
       caption = "Average marginal differences in the probability of being clearly behind grade by monoracial group, relative to a monoracial white student",
       caption.above=TRUE,
       custom.gof.rows=
         list("State fixed effects" = c("Yes","Yes","Yes","Yes"),
              "Location fixed effects" = c("Yes","Yes","Yes","Yes"),
              "Grade fixed effects" = c("Yes","Yes","Yes","Yes"),
              "Year linear effects" = c("Yes","Yes","Yes","Yes"),
              "Year x grade effects"  = c("Yes","Yes","Yes","Yes"),
              "Nativity and language" = c("No","Yes","Yes","Yes"),
              "Parent's education" = c("No","No","Yes","Yes"),
              "Family resources" = c("No","No","No","Yes")))
```

-   Show panelized figures for each group from fixed effect model to full model.

```{r fig-black-models}
#| label: fig-black-models
#| fig-cap: Probability of being behind grade for biracial respondents with one black parent, in comparison to their monoracial comparison groups. 83.4% confidence bands shown around each estimate. Non-overlap in confidence bands roughly indicates statistically significant difference at the 5% level, Baseline model includes year, grade, location, and state fixed effects. Full models include control variables for nativity, English proficiency, income, education, home ownership, and marital status of parents.
#| fig-height: 7.5
coef_table %>%
  filter(model=="Baseline model" | model=="Full model") %>%
  filter(str_detect(mrace, "Black")) %>%
  ggplot(aes(x=term, y=estimate, color=multiracial,
             ymin=estimate-1.386*se, ymax=estimate+1.386*se))+
  geom_rect(aes(xmax=Inf, xmin=-Inf, ymin=estimate_mid-1.386*se_mid,
                ymax=estimate_mid+1.386*se_mid, fill=multiracial), 
            color=NA, alpha=0.2)+
  geom_linerange(data=subset(coef_table, multiracial 
                             & (model=="Baseline model" | 
                                  model=="Full model") & 
                               str_detect(mrace, "Black")))+
  geom_point()+
  coord_flip()+
  facet_grid(mrace~model, scales="free_y")+
  theme_bw()+
  theme(legend.position = "none", panel.grid = element_blank())+
  scale_color_manual(values=c("grey40","red"))+
  scale_fill_manual(values=c("grey40","red"))+
  scale_linetype_manual(values=c(3,1))+
  scale_y_continuous(labels = scales::percent)+
  labs(x=NULL,
       y="average predicted probability of being clearly behind expected grade")
```

```{r fig-other-models}
#| label: fig-other-models
#| fig-cap: Probability of being behind grade for non-black biracial respondents, in comparison to their monoracial comparison groups. 83.4% confidence bands shown around each estimate. Non-overlap in confidence bands roughly indicates statistically significant difference at the 5% level, Baseline model includes year, grade, location, and state fixed effects. Full models include control variables for nativity, English proficiency, income, education, home ownership, and marital status of parents.
#| fig-height: 7.5
coef_table %>%
  filter(model=="Baseline model" | model=="Full model") %>%
  filter(!str_detect(mrace, "Black")) %>%
  ggplot(aes(x=term, y=estimate, color=multiracial,
             ymin=estimate-1.386*se, ymax=estimate+1.386*se))+
  geom_rect(aes(xmax=Inf, xmin=-Inf, ymin=estimate_mid-1.386*se_mid,
                ymax=estimate_mid+1.386*se_mid, fill=multiracial), 
            color=NA, alpha=0.2)+
  geom_linerange(data=subset(coef_table, multiracial 
                             & (model=="Baseline model" | 
                                  model=="Full model") & 
                               !str_detect(mrace, "Black")))+
  geom_point()+
  coord_flip()+
  facet_grid(mrace~model, scales="free_y")+
  theme_bw()+
  theme(legend.position = "none", panel.grid = element_blank())+
  scale_color_manual(values=c("grey40","red"))+
  scale_fill_manual(values=c("grey40","red"))+
  scale_linetype_manual(values=c(3,1))+
  scale_y_continuous(labels = scales::percent)+
  labs(x=NULL,
       y="average predicted probability of being clearly behind expected grade")
```
