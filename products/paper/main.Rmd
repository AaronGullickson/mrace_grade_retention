---
title: "The Title"
author:
- affiliation: University of Oregon, Sociology
  name: Aaron Gullickson
keywords: keywords
#FYI: the thanks and abstract are easier to view and edit in Atom which does proper linewrapping
thanks: Thanks to people and stuff
abstract: This is a test abstract
output:
  pdf_document:
    citation_package: natbib
    fig_caption: yes
    template: ./resources/aog-latex-ms.tex
  word_document:
    reference_docx: ./resources/aog_word_style.docx
fontfamily: mathpazo
fontsize: 11pt
anonymous: false #anonymize, double-space, and ragged right
endnotes: false #make footnotes endnotes
endfloat: false #move table and figures to the end
bibliography: ../project.bib
biblio-style: ./resources/ajs.bst
---

```{r setup, echo=FALSE, warning=FALSE, error=FALSE, include=FALSE}
# If you want to do things in one R Markdown document then use the 
# chunk option eval to toggle between running with and without 
# compiling R code chunks
knitr::opts_chunk$set(echo = FALSE, message = FALSE, error = FALSE, 
                      warning = FALSE, eval = TRUE)
library(here)
source(here("analysis","check_packages.R"))
source(here("analysis","useful_functions.R"))
```

```{r load-data}
load(here("analysis","output","acs.RData"))
load(here("analysis","output","coef_table.RData"))
load(here("analysis","output","monoracial_results.RData"))
```

# Introduction

# Background

# Data and Methods

-   Discuss ACS data source. Only includes children living in a household with two parents who are likely biological parents.
-   How are multiracial children identified?
-   How is grade retention determined?
-   Model building - basic model is a logit model of grade retention. All models include:
    -   state fixed effects
    -   linear year effect
    -   grade fixed effect
    -   grade * linear year fixed effect
    -   location of student (metro, suburb, rural) fixed effects
-   All models also account for occassional clustering of multiple respondents in the same household.
-   I then test nested models that include other family resources that may affect grade retention:
    -   nativity (own and each parent) and english proficiency (own and each parent)
    -   parents' education, measured by highest degree of each parent
    -   other family resources: family income (square rooted), whether they own their own home, and whether parents are married.
-   Because the research question is about where biracials fit relative to their monoracial comparison groups, no coding of reference categories will produce a complete results from model output. Instead, I use the model to calculate average adjusted predicted probabilities of grade retention for each racial (mono and bi) group. Explain what an average adjusted predicted probability is (like an AME but on the level rather than the difference).
-   Given these predicted probabilities, I then use a graphical technique to display most results. Go through example using the raw probabilities for white, black, and white/black respondents.
-   Show the figure for raw model 0 data for white/black

```{r example-plot, fig.cap="Probability of being behind grade for biracial black/white respondents in comparison to their monoracial comparison groups. 83.4% confidence bands shown around each estimate. Non-overlap in confidence bands roughly indicates statistically significant difference at the 5% level"}
g <-  coef_table %>%
  filter(mrace=="Black/White" & model=="crude") %>%
  ggplot(aes(x=term, y=estimate, color=multiracial,
             ymin=estimate-1.386*se, ymax=estimate+1.386*se))+
  geom_rect(aes(xmax=Inf, xmin=-Inf, ymin=estimate_mid-1.386*se_mid,
                ymax=estimate_mid+1.386*se_mid, fill=multiracial), 
            color=NA, alpha=0.2)+
  geom_linerange(data=subset(coef_table, multiracial & mrace=="Black/White" &
                               model=="crude"))+
  geom_point()+
  coord_flip()+
  theme_bw()+
  theme(legend.position = "none", panel.grid = element_blank())+
  scale_color_manual(values=c("grey40","red"))+
  scale_fill_manual(values=c("grey40","red"))+
  scale_linetype_manual(values=c(3,1))+
  scale_y_continuous(labels = scales::percent)+
  labs(x=NULL,
       y="predicted probability of being behind expected grade")

g+annotate("text", 1, 0.035, hjust="left",
             label="Grey bands give 83.4%\nconfidence interval around\nmonoracial estimates")+
  annotate("text", 2, 0.045, hjust="left",
             label="Red band gives 83.4%\nconfidence interval around\nmidpoint estimate")+
  annotate("text", 2.5, 0.036, hjust="left",
             label="Actual biracial estimate\nshown with 83.4% confidence\ninterval")
```

# Results

-   Show table of results for monoracial respondents across different models

```{r monoracial-results, results='asis'}
knitreg(map(results_monoracial, convert_marg),
        digits=3, caption="Average marginal differences in the probability of being behind grade by monoracial group, relative to a monoracial white student",
        caption.above=TRUE,
        custom.gof.rows=
          list("State fixed effects" = c("Yes","Yes","Yes","Yes"),
               "Grade fixed effects" = c("Yes","Yes","Yes","Yes"),
               "Year linear effects" = c("Yes","Yes","Yes","Yes"),
               "Year x Grade effects"  = c("Yes","Yes","Yes","Yes"),
               "Location fixed effects" = c("Yes","Yes","Yes","Yes"),
               "Nativity and language" = c("No","Yes","Yes","Yes"),
               "Parent's education" = c("No","No","Yes","Yes"),
               "Family resources" = c("No","No","No","Yes")))
```

-   Show panelized figures for each group from fixed effect model to full model.

```{r cond-means-model-compare, fig.height=9, fig.cap="Probability of being behind grade for biracial respondents in comparison to their monoracial comparison groups. 83.4% confidence bands shown around each estimate. Non-overlap in confidence bands roughly indicates statistically significant difference at the 5% level. Each panel is based on a different model that accounts for certain variables. Subsequent panels cumulatively include all prior terms."}
coef_table %>%
  filter(model=="fixed effects" | model=="parent resources") %>%
  ggplot(aes(x=term, y=estimate, color=multiracial,
             ymin=estimate-1.386*se, ymax=estimate+1.386*se))+
  geom_rect(aes(xmax=Inf, xmin=-Inf, ymin=estimate_mid-1.386*se_mid,
                ymax=estimate_mid+1.386*se_mid, fill=multiracial), 
            color=NA, alpha=0.2)+
  geom_linerange(data=subset(coef_table, multiracial 
                             & (model=="fixed effects" | 
                                  model=="parent resources")))+
  geom_point()+
  coord_flip()+
  facet_grid(mrace~model, scales="free_y")+
  theme_bw()+
  theme(legend.position = "none", panel.grid = element_blank())+
  scale_color_manual(values=c("grey40","red"))+
  scale_fill_manual(values=c("grey40","red"))+
  scale_linetype_manual(values=c(3,1))+
  scale_y_continuous(labels = scales::percent)+
  labs(x=NULL,
       y="average adjusted predicted probability of being behind expected grade")
```

# Conclusions
